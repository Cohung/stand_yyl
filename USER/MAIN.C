#include "STC89C5xRC_RDP.h"
#include <string.h>
#include <intrins.h>
#include "main.h"
#include "slrc531.h"
//#include "iso14443a.h"
#include "iso14443b.h"
#include "12864.h"
#include "DS1302.H"
#include <absacc.h>
#include "STC12EROM.h"
#include "KEY.H"
#include "SC8020B.H"
#include "Mentor.h"
//硬件版本号         
uint sum_id;
//uint SET_DIS = 1;
uchar nian = 13;
uchar yue  = 10;
uchar ri   = 31;
uchar user_channel = 0;
bit mentor_off=0;
unsigned char s = 0; //在中断函数中
unsigned char Time_Range=0;
unsigned char idata set_led_time[4]={18,30,6,30};
unsigned int led_start,led_end;
bit led_on=1;
extern unsigned char set_num,tab_num,store_timerange,store_ledtime[4];//删去了extern
unsigned char TIME[6];
extern unsigned char t_tmp[6];
bit b;
bit b_flesh=0;
unsigned int min,sec;
//unsigned char int0_flag=0;
unsigned int a;
unsigned char start_long_set=0,long_set=0,tmp_show,for_num2_clr;
unsigned int aa;//,set_long_time,set_long_time_flag;
unsigned char update_logo=0;

uchar ee_indx=0;
uchar ee_id=0;

uchar ask_a=0;
bit   ask_it=0;
unsigned char xdata eesector[] =
{
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
unsigned char xdata dd_1[]=
{
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00

};

unsigned char code Cl[]=
{
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00

};

unsigned char code dig_9[]=
{
 0x60,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0xa0,0x60,//'0'
 0x60,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x70,//'1'
 0x60,0x90,0x90,0x10,0x20,0x20,0x40,0x40,0x90,0xf0,//'2'
 0x60,0x90,0x90,0x10,0x60,0x10,0x10,0x90,0x90,0x60,//'3'
 0x10,0x30,0x50,0x50,0x90,0x90,0xf8,0x10,0x10,0x38,//'4'
 0xf0,0x80,0x80,0xe0,0x90,0x10,0x10,0x90,0x90,0x60,//'5'
 0x60,0xa0,0x80,0x80,0xe0,0x90,0x90,0x90,0x90,0x60,//'6'
 0xf0,0x90,0x20,0x20,0x40,0x40,0x40,0x40,0x40,0x40,//'7'
 0x60,0x90,0x90,0x90,0x60,0xa0,0x90,0x90,0x90,0x60,//'8'
 0x60,0x90,0x90,0x90,0x90,0x70,0x10,0x10,0x60,0x60,//'9'
 0x00,0x00,0x00,0x00,0xf8,0x00,0x00,0x00,0x00,0x00,//'--'
 0x00,0x00,0x00,0x60,0x60,0x00,0x60,0x60,0x00,0x00,//':'
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 //' '

};

unsigned char code Chinese_SHU[]=
{
 0x08,0x20,0x49,0x20,0x2A,0x20,0x08,0x3E,
 0xFF,0x44,0x2A,0x44,0x49,0x44,0x88,0xA4,
 0x10,0x28,0xFE,0x28,0x22,0x10,0x42,0x10,
 0x64,0x28,0x18,0x28,0x34,0x44,0xC2,0x82  /*"数",0*/
};

unsigned char code ALL_ZERO[32]=
{
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

// unsigned char code AD_1[]=
// {
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 1
//  0x00,0x03,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 2
//  0x00,0x1f,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0x7f,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0xfc,0x03,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x01,0xe0,0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x07,0xe0,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x07,0xc0,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x0f,0x80,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 9
//  0x0e,0x00,0x00,0x09,0xe0,0x7c,0x00,0x28,0x02,0x20,0x47,0x88,0x91,0x1e,0x04,0x00,// 10
//  0x1e,0x00,0x00,0x03,0xe0,0xfc,0x00,0x2c,0x02,0x20,0xf4,0x8a,0xa0,0x92,0x0f,0xe0,// 11
//  0x1c,0x00,0x00,0x07,0xc1,0xf8,0x00,0x20,0x1f,0xfd,0x24,0x92,0xc8,0x92,0x08,0x20,
//  0x1c,0x00,0x00,0x07,0x93,0xf8,0x00,0x27,0xc0,0x81,0xfc,0xbf,0x88,0x22,0x14,0x40,// 13
//  0x3c,0x00,0x00,0x0f,0xb3,0xf3,0x01,0xf8,0x0f,0xf8,0x67,0x81,0x8b,0x41,0xa3,0x80,// 14
//  0x3c,0x00,0x00,0x0f,0x7b,0xf7,0x00,0x31,0x00,0x80,0xd4,0x9e,0xf1,0x00,0x07,0xc0,// 15
//  0x3c,0x00,0x00,0x1f,0x79,0xe7,0x80,0x11,0x1f,0xfd,0x88,0x12,0x01,0x3f,0x38,0x38// 16
//  };
//  unsigned char code AD_2[]=
//  {
//  0x3c,0x00,0x00,0x1e,0x3c,0xe3,0x80,0x12,0x00,0x80,0x7f,0x1e,0x99,0x21,0x1f,0xe0,
//  0x3c,0x00,0x00,0x3e,0x3c,0x61,0xe0,0x0c,0x1f,0xfc,0x41,0x12,0xb1,0x12,0x11,0x20,// 18
//  0x3c,0x00,0x06,0x3c,0x1e,0x41,0xe0,0x08,0x40,0x80,0x7f,0x1e,0xc1,0x0c,0x1f,0xe0,
//  0x3c,0x00,0x06,0x7c,0x1e,0x00,0xf0,0x14,0x41,0x40,0x41,0x12,0x88,0xcc,0x11,0x20,
//  0x1e,0x00,0x06,0x78,0x0e,0x00,0xf0,0x62,0x86,0x30,0x7f,0x12,0x88,0x33,0x1f,0xe0,// 21
//  0x1e,0x00,0x06,0x78,0x0e,0x00,0x78,0x81,0x98,0x0c,0x41,0x16,0xf0,0x40,0x80,0x00,
//  0x0f,0x80,0x06,0x00,0x00,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x0f,0xc0,0x06,0x00,0xa0,0x7f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x0f,0xe0,0x06,0x00,0x80,0x08,0x00,0x55,0x55,0x43,0x29,0x8f,0x9c,0xc1,0x98,0xf8,// 25
//  0x07,0xf0,0x06,0x07,0xf8,0x7f,0x00,0x55,0x55,0x44,0xaa,0x52,0x45,0x22,0x25,0x24,
//  0x03,0xff,0xfe,0x00,0x80,0x08,0x00,0x55,0x55,0x40,0xaa,0x52,0x49,0x22,0x25,0x24,
//  0x00,0xff,0xfe,0x00,0x98,0x7f,0x00,0x55,0x55,0x43,0xa9,0xd2,0x49,0x22,0x25,0x24,// 28
//  0x00,0x7f,0xfe,0x00,0xe0,0x08,0x00,0x55,0x55,0x44,0xa8,0x52,0x49,0x22,0x25,0x24,
//  0x00,0x1f,0xfe,0x07,0x80,0x7f,0x00,0x69,0xa6,0x84,0x98,0x52,0x51,0x22,0x25,0x24,// 30
//  0x00,0x00,0x00,0x00,0x78,0x77,0x00,0x28,0xa2,0x97,0x92,0x52,0x5d,0x29,0x99,0x24,
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x61,0x80,0x00,0x00,0x00,0x00// 32
//  };
//  unsigned char code AD_3[]=
//  {
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 35
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0x01,0x00,0x7e,0x10,0x00,0x00,0x11,0x00,0x04,0x00,0x10,0x80,0x40,0x00,0x00,
//  0x00,0x4f,0xf0,0x42,0x10,0x00,0x00,0x11,0x40,0x1f,0xc0,0x12,0x80,0x2f,0xf0,0x00,// 38
//  0x00,0x21,0x00,0x7e,0x50,0x7f,0xe0,0x21,0x20,0x10,0x40,0x22,0x40,0x20,0x80,0x00,
//  0x00,0x07,0xe0,0x40,0x50,0x00,0x00,0x21,0x00,0x1f,0xc0,0x24,0x40,0x00,0x80,0x00,
//  0x00,0xe1,0x00,0x48,0x50,0x00,0x00,0x6f,0xf0,0x10,0x40,0x64,0x20,0xe4,0x80,0x00,// 41
//  0x00,0x2f,0xf0,0x7e,0x50,0x00,0x00,0xa1,0x00,0x1f,0xd0,0xaf,0xd0,0x24,0xe0,0x00,
//  0x00,0x24,0x20,0x6a,0x50,0x00,0x00,0x21,0x00,0x10,0x60,0x32,0x40,0x24,0x80,0x00,
//  0x00,0x27,0xe0,0xaa,0x50,0x00,0x00,0x21,0x00,0x7f,0xc0,0x22,0x40,0x24,0x80,0x00,// 44
//  0x00,0x2c,0x20,0xaa,0x50,0x00,0x00,0x20,0x80,0x01,0x40,0x22,0x40,0x2c,0x80,0x00,
//  0x00,0x37,0xe0,0xaa,0x50,0x00,0x00,0x20,0x90,0x06,0x40,0x24,0x40,0x34,0x80,0x00,// 46
//  0x00,0x24,0x20,0x2e,0x10,0xff,0xf0,0x20,0x50,0x18,0x40,0x24,0x40,0x2f,0xf0,0x00,
//  0x00,0x04,0x60,0x08,0x30,0x00,0x00,0x20,0x30,0xe1,0x80,0x28,0xc0,0x00,0x00,0x00
//  };


 unsigned char code ji_sheng_1[]=
 {
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x7e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x8e,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x1d,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x3a,0x07,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x17,0x7b,0x0e,0x18,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x74,0x38,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x1b,0x7a,0x38,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x10,0xee,0xf0,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x55,0xd3,0x60,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x3b,0xa1,0x80,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x1f,0x41,0xe0,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x3c,0x83,0xbe,0x38,0x00,0x00,0x00,0x00,0x00,0x00
 };
  unsigned char code ji_sheng_2[]=
{
  0x00,0x00,0x00,0x00,0x00,0x00,0x1f,0x07,0x8f,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x54,0x07,0x03,0xe0,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x0e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x14,0x18,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x60,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x3d,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x20,0x02,0x30,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xa8,0x91,0xd0,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x64,0x4b,0x90,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xff,0xfd,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0xca,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
  };
  //计生页面的第三行用请刷二代身份证替代
  unsigned char code ji_sheng_3[]=
  {
//  0x08,0x20,0x50,0x81,0x00,0x40,0x22,0x1f,0xe0,0x80,0x0a,0x09,0x20,0x8c,0x09,0xe0,
//  0x08,0x20,0x50,0x89,0x07,0xfd,0xff,0xd0,0x20,0xf8,0x7f,0xc9,0x30,0x88,0x09,0x20,
//  0x04,0x20,0x42,0x89,0x01,0x10,0x22,0x1f,0xe1,0x08,0x0a,0x49,0x00,0x88,0x3f,0x20,
//  0x00,0x20,0x52,0x8f,0xf2,0x08,0x44,0x10,0x23,0xfe,0x7f,0xcf,0xfb,0xef,0x89,0x20,
//  0x1d,0xfc,0xf2,0x91,0x07,0xf8,0x87,0x9f,0xe6,0x22,0x4a,0x01,0x01,0x09,0x09,0x20,
//  0x04,0x23,0xc2,0x91,0x00,0x00,0xa8,0x90,0x22,0x22,0x7f,0xc2,0x01,0x19,0x19,0x20,
//  0x04,0x20,0x4a,0xa1,0x03,0xf8,0xe8,0x9f,0xe3,0xfe,0x12,0x43,0xf9,0xe9,0x1d,0x20,
//  0x04,0x20,0x5a,0x9f,0xf2,0x08,0x44,0x90,0x22,0x40,0x3f,0xc3,0x11,0x29,0x2d,0x20,
//  0x04,0x20,0x52,0x81,0x03,0xf8,0x84,0xbf,0xf8,0x60,0x60,0x85,0x11,0x25,0x29,0x28,
//  0x04,0xa0,0x62,0x81,0x02,0x08,0xa2,0x80,0x00,0xa1,0x24,0x84,0xa1,0x22,0x29,0x28,
//  0x05,0x20,0xc8,0x81,0x03,0xf8,0xc0,0x84,0x40,0xa1,0x24,0x88,0x41,0x27,0x09,0x28,
//  0x06,0x23,0x28,0x81,0x02,0x08,0x30,0x98,0x33,0x21,0x0b,0x09,0xb1,0x29,0x89,0x28,
//  0x0c,0x20,0x1b,0xbf,0xfa,0x18,0xc7,0x30,0x16,0x1e,0x70,0xd6,0x0b,0x50,0xcb,0x38,
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 35
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x01,0x00,0x7e,0x10,0x00,0x00,0x11,0x00,0x04,0x00,0x10,0x80,0x40,0x00,0x00,
  0x00,0x4f,0xf0,0x42,0x10,0x00,0x00,0x11,0x40,0x1f,0xc0,0x12,0x80,0x2f,0xf0,0x00,// 38
  0x00,0x21,0x00,0x7e,0x50,0x7f,0xe0,0x21,0x20,0x10,0x40,0x22,0x40,0x20,0x80,0x00,
  0x00,0x07,0xe0,0x40,0x50,0x00,0x00,0x21,0x00,0x1f,0xc0,0x24,0x40,0x00,0x80,0x00,
  0x00,0xe1,0x00,0x48,0x50,0x00,0x00,0x6f,0xf0,0x10,0x40,0x64,0x20,0xe4,0x80,0x00,// 41
  0x00,0x2f,0xf0,0x7e,0x50,0x00,0x00,0xa1,0x00,0x1f,0xd0,0xaf,0xd0,0x24,0xe0,0x00,
  0x00,0x24,0x20,0x6a,0x50,0x00,0x00,0x21,0x00,0x10,0x60,0x32,0x40,0x24,0x80,0x00,
  0x00,0x27,0xe0,0xaa,0x50,0x00,0x00,0x21,0x00,0x7f,0xc0,0x22,0x40,0x24,0x80,0x00,// 44
  0x00,0x2c,0x20,0xaa,0x50,0x00,0x00,0x20,0x80,0x01,0x40,0x22,0x40,0x2c,0x80,0x00,
  0x00,0x37,0xe0,0xaa,0x50,0x00,0x00,0x20,0x90,0x06,0x40,0x24,0x40,0x34,0x80,0x00,// 46
  0x00,0x24,0x20,0x2e,0x10,0xff,0xf0,0x20,0x50,0x18,0x40,0x24,0x40,0x2f,0xf0,0x00,
  0x00,0x04,0x60,0x08,0x30,0x00,0x00,0x20,0x30,0xe1,0x80,0x28,0xc0,0x00,0x00,0x00
 };

//
bit ad;					
bit g_bReceOk;                                              //正确接收到上位机指令标志
bit g_bReceAA;                                              //接收到上位机发送的AA字节标志
bit g_bRc632Ok;                                             //RC632复位正常标志
bit g_bIblock;


//unsigned int  g_cReceNum;                                   //接收到上位机的字节数
//unsigned int  data g_cCommand;                              //接收到的命令码
//unsigned char data g_cSNR[4];                               //M1卡序列号
//unsigned char g_cIcdevH;                                    //设备标记
//unsigned char g_cIcdevL;                                    //设备标记
unsigned char g_cFWI;                                       //
//unsigned char g_cCidNad;                                    //
unsigned char idata g_cReceBuf[64];                         //和上位机通讯时的缓冲区

struct TranSciveBuffer{unsigned char MfCommand;
                       unsigned int  MfLength;
                       unsigned char MfData[64];
                      };

uint num_times=0;
void main( )
{    
 	  uchar t_tmp;
	
	uint del_1;

	bit jiaole = 0;
		del_1 = 0;
	sc_data = 0;
	sc_rst=1;
	 InitializeSystem( );
	delay_us(100); //
	sc_rst=0;
	delay_us(100);
	Delay_50us(200);
	Delay_50us(200);
	  a = 0;
	  aa=0;
	 //ad = 0;
	  tmp_show = 0;

	  
	 
	  EA = 1;
	  
	  ET0 = 1;
	  ET1 = 1;


	  TMOD = 0X11;
	  TH0 = 0Xc8;
	  TL0 = 0Xc0;
	 
	  TH1 = 0X3c;
	  TL1 = 0Xb0;

	 initial_LCD();
     
	 	  
	 

	 Rc632Ready( );
    PcdConfigISOType( 'A' );  //上位默认为A协议
	
//	 DispalyLcd();
	 //上电时让刷卡指示灯控制默认在高电平，不亮
	  Init_DS1302();
	  DelayMs(20);
	  RE_DS1302();

	  Clean_12864_GDRAM();
	  WriteCommand(0x30);
	  Draw_LOGO(ji_sheng_1,ji_sheng_2,ji_sheng_3);

	  Draw_Dig(1,2,dig_9,dd_1);
	  Draw_Dig(2,0,dig_9,dd_1);
	  Draw_Dig(3,TIME[0]/16,dig_9,dd_1);
	  Draw_Dig(4,TIME[0]%16,dig_9,dd_1);
	  Draw_Dig(5,10,dig_9,dd_1);
	  Draw_Dig(6,TIME[1]/16,dig_9,dd_1);
	  Draw_Dig(7,TIME[1]%16,dig_9,dd_1);
	  Draw_Dig(8,10,dig_9,dd_1);
	  Draw_Dig(9,TIME[2]/16,dig_9,dd_1);
	  Draw_Dig(10,TIME[2]%16,dig_9,dd_1);
	  Draw_Dig(15,TIME[3]/16,dig_9,dd_1);
	  Draw_Dig(16,TIME[3]%16,dig_9,dd_1);
	  Draw_Dig(17,11,dig_9,dd_1);
	  Draw_Dig(18,TIME[4]/16,dig_9,dd_1);
	  Draw_Dig(19,TIME[4]%16,dig_9,dd_1);
	  
	  LCD_16128Graphic(0,4,dd_1); 
	  LCD_16128Graphic(1,4,dd_1);
	  LCD_16128Graphic(2,4,dd_1); 
	  LCD_16128Graphic(3,4,dd_1);
	  LCD_16128Graphic(4,4,dd_1); 
	  LCD_16128Graphic(5,4,dd_1);
	  LCD_16128Graphic(6,4,dd_1); 
	  LCD_16128Graphic(7,4,dd_1);

	  for(del_1=0;del_1<100;del_1++)
		 DelayMs(200);

 	   
	 
	    lcdak = 0;
		TR0 = 1;
		TR1 = 1;
     while ( 1 )
     { 
		
		 
		  if(ask_it==1){
		    LCD_Display_Clock(dig_9,dd_1);
		  
			if(set_num == 0){ 
					//TR0 = 0;
					g_cReceBuf[6]=1; //开启天线
					ComPcdAntenna();
					PcdConfigISOType( 'B' );//选择TYPE B
					//TR0 = 1; 	
					request();
			}
		 
		    ask_it = 0;
		  }


	


		if(set_num == 0){
			if((TIME[5]/16*10+TIME[5]%16)%4 == 0)
							{
								
								if(ad == 1)
								  {
								  if(t_tmp!=TIME[5]){
									  LCD_PutString(0,1,"                ");
									LCD_PutString(0,2,"                ");  
									LCD_PutString(0,3,"                "); //以上清文字屏 
								  Draw_LOGO(ji_sheng_1,ji_sheng_2,ji_sheng_3);
								  ad = 0;}
								 // update_logo = 1;
								   
								  }
								  else
								  {
								  if(t_tmp!=TIME[5]){

									Draw_LOGO(Cl,Cl,Cl);//以上清图案屏

									  
									  LCD_PutString(0,1,"本机已发放药具：");
									  LCD_PutString(0,3,"          盒    "); 
									  WriteCommand(0x30);
									  WriteCommand(0x89);
									  WriteData(0X30+num_times/10000);
									  WriteData(0X30+num_times/1000%10);
									  WriteData(0X30+num_times/100%10);
									  WriteData(0X30+num_times/10%10);
									  WriteData(0X30+num_times%10);  
								  ad = 1;
								  }
								 // update_logo = 1;
								  
								  }
								  
								  t_tmp = TIME[5];
							 } 			
			
	 
			  			}
	 if(set_num ==0||set_num==1||set_num==2||set_num==3)
	 	set_table();
	 /*在设置界面的第一三两个界面闪烁*/
	 if(set_num == 1 || set_num == 3){
	 		//TR0 = 0;
		 	if(b_flesh==1){
			if(b==1)
			flesh_set();
			else
			flesh_clr();
			}
			//TR0 = 1;
		}
	 /*在用户刷卡后进入选择货道状态*/
	  if(set_num == USER_STATE){
		  if(user_channel==0)
		 	user_ch(); 		
		}

		
	 /*在用户时间限制或是无药品或领用选择时显示一段时间的错误提示*/	
	  	if((set_num == USER_STATE_ERR)||(set_num == NO_INV_STATE) || (set_num == USER_STATE)){
				if(tmp_show>8)
					{
						set_num = 0;
						update_logo=1;
						tmp_show = 0;
						user_channel = 0;
						for(s=1;s<4;s++)		
							LCD_PutString(0,s,"                ");
			//			aa = 225;
					}
			}

		/*显示一段时间的请取货界面，电机状态另行控制*/
		if(set_num == GET_INV_STATE) //如果用户不取货
		{
					
			
			if((tmp_show>4) && (a>5)) //到请取货状态
				{
					
		//	BEEP(40);		
					user_channel=0;
					

			set_num = THANKS;
			TR0 = 0;
			mentor_off = 1;
			tmp_show = 0;
			TH0 = 0Xc8;
			TL0 = 0Xc0;
			a=0;
			TR0 = 1;
			LCD_PutString(0,1,"                ");
			LCD_PutString(0,2,"                ");
			LCD_PutString(0,3,"                ");
			DisplayLcd(GET_INV); 
					sc_speech(5);
				}

			//BEEP(40);

			if(pos1 == 0)
			{
					DelayMs(5);  //一次延时的方式
				    if(pos1 == 0)
						set_num = POS_ON;
			}
				
		//	if(tmp_show>1)
			//a = 0;
		
		}
		//if(set_num!=0&&set_num!=USER_STATE&&set_num!=USER_STATE_ERR&&set_num!=POS_ON&&set_num!=GET_INV_STATE){
		/*在维护设置的三个界面中，如一段时间不操作，也回退到待机界面，有BUG*/
		if(set_num==1||set_num==2||set_num==3){
			if(tmp_show>15){		
				if(set_num == 2)
				Time_Range = store_timerange;

				if(set_num == 3)
				{
				for(s=1;s<5;s++)	
				set_led_time[s-1] = store_ledtime[s-1];
				}
//				if(set_num == 3)
//				{led_start = set_led_time[0]*60+set_led_time[1];
//				led_end = set_led_time[2]*60+set_led_time[3];}
				start_long_set = 0;
				long_set = 0;
				set_num = 0;
				update_logo=1;			
				tmp_show = 0;
				//ClrScreen();
				BEEP(50);
				for(s=1;s<4;s++){		
					
					LCD_PutString(0,s,"                ");
					}
				
			//	aa = 235;
				}
				

		}
		

		if(set_num == POS_ON)
		{
	 		DelayMs(1600);
				if(pos1 == 0)
				{
					DelayMs(5);  //一次延时的方式
				    if(pos1 == 0)						
						set_num = POS_ON;
									
				}
				else{				
								set_num = TO_THANKS;
								TR0 = 0;
								mentor_off = 1;
								tmp_show = 0;
								TH0 = 0Xc8;
								TL0 = 0Xc0;
								a=0;
								TR0 = 1;
								LCD_PutString(0,1,"                ");
								LCD_PutString(0,2,"                ");
								LCD_PutString(0,3,"                ");
								DisplayLcd(GET_INV);  
								sc_speech(5);
						
				}
	
		
		}

		if(mentor_off==1)
		{
			M_OFF();
				user_channel = 0;
				mentor_off = 0;
		//	}	
		}

			if(set_num==TO_THANKS){

		if(tmp_show>6){
		//LCD_PutString(0,1,"                "); 
	    LCD_PutString(0,2,"    谢谢使用!   ");
	    //LCD_PutString(0,3,"                ");
			set_num = THANKS;

			
		}
		
	}		
		if(set_num==THANKS){

		
		if(tmp_show>15){
							sc_speech(7); 
				  	 //TR0 = 0;
				for(s=1;s<4;s++)		
					 LCD_PutString(0,s,"                "); 	
				   tmp_show = 0;
				   set_num = 0;				   
					 a=0;
			update_logo=1;
					 //aa = 235;	
					 //TR0 = 1;
			}

		}	 
	   
     }
	
}



/////////////////////////////////////////////////////////////////////
//系统初始化
/////////////////////////////////////////////////////////////////////
void InitializeSystem()
{
	uchar j;
	P4SW |= 0X50; //设置P4.4,P4.6为普通IO口
	P4M1 = 0X00;
	P4M0 = 0X14;
	
	P3M1 = 0X00;
	P3M0 = 0X28;

	P2M1 = 0X00;
	P2M0 = 0X40;
	
	P1M1 = 0X00;
	P1M0 = 0X20;
	
	Delay_50us(5);

	
	mled = 1;  //根据灯管启停时间和预设的时间，上电时应处于开启状态
	HC139_EN=10;


	led_start = set_led_time[0]*60+set_led_time[1];
	led_end = set_led_time[2]*60+set_led_time[3];
		
//	for(j=0;j<58;j++)
//	 	C_EROM(j);
	j = R_EROM(57,0);
	if(j != 0xff)
	{
		Time_Range = j;
	
	} 	
	j = R_EROM(57,1);
	if(j != 0xff){
	set_led_time[0] = R_EROM(57,1);
	set_led_time[1] = R_EROM(57,2);
	set_led_time[2] = R_EROM(57,3);
	set_led_time[3] = R_EROM(57,4);
	}
	j = R_EROM(57,5);
	if(j != 0xff)
		num_times = j;
	j = R_EROM(57,6);
	if(j != 0xff)
		num_times = j*10+num_times;
	j = R_EROM(57,7);
	if(j != 0xff)
		num_times = j*100+num_times;
	j = R_EROM(57,8);
	if(j != 0xff)
		num_times = j*1000+num_times;
	j = R_EROM(57,9);
	if(j != 0xff)
		num_times = j*10000+num_times;
//	else{
//	set_led_time[0] = 18;
//	set_led_time[1] = 30;
//	set_led_time[2] = 6;
//	set_led_time[3] = 30;}
	j = R_EROM(57,10);
	if(j != 0xff){
	ee_indx = R_EROM(57,10);
	ee_id   = R_EROM(57,11);
	}
}

/////////////////////////////////////////////////////////////////////
//初始化RC632
/////////////////////////////////////////////////////////////////////
void Rc632Ready()
{
    char status;
    DelayMs(100);
    DelayMs(100);
	DelayMs(100);
    DelayMs(100);
    DelayMs(100);
   


    status = PcdReset();
    if(status != MI_OK)
    {
        DelayMs(10);
        status = PcdReset();
    } 
    if(status != MI_OK)
    {
        DelayMs(10);
        status = PcdReset();
    } 
    if(status == MI_OK)
    {
 
			BEEP(40);		

    }       
}
//	
 
///////////////////////////////////////////////////////////////////////
////响应上位机发送的天线命令
///////////////////////////////////////////////////////////////////////
void ComPcdAntenna()
{
    char status;
    if (!g_cReceBuf[6])		 //为0时关闭天线
    {   status = PcdAntennaOff();   }
    else
    {  
        DelayMs(1); 		  //反之则开启
        status = PcdAntennaOn();
        DelayMs(1);
		
    }
   

	
}    
//


void BEEP(unsigned char i)
{
    unsigned int k;
	k=i*80;		
	buzz = 0;
	
	
//	led =  0;	

	DelayMs(k);		
	buzz =1; 	

 //	led =  1;
   
}

void Write_E(uchar n,uint x,uchar dat)
{
	uint i;
	for(i=0;i<512;i++)
		eesector[i]=R_EROM(n,i);
	eesector[x] = dat;
	C_EROM(n);
	for(i=0;i<512;i++)
		W_EROM(n,i,eesector[i]);

}
void Write_EE_rec(uchar y,uchar m,uchar d)
{
	uint i;
	ee_id = ee_id+1;
	if(ee_id==16)
	{
		ee_id = 0;
		ee_indx = ee_indx+1;
		if(ee_indx == 57)
			ee_indx = 0;
	}
	
	for(i=0;i<512;i++)
		eesector[i]=R_EROM(ee_indx,i);
	
	eesector[ee_id*32+0] = y;
	eesector[ee_id*32+1] = m;
	eesector[ee_id*32+2] = d;
	for(i=0;i<8;i++)
		eesector[ee_id*32+3+i]=g_cReceBuf[i];
	C_EROM(ee_indx);
	for(i=0;i<512;i++)
		W_EROM(ee_indx,i,eesector[i]);
	
	Write_E(57,10,ee_indx);Write_E(57,11,ee_id);

}
  
void request()	   // 寻卡(对身份证或其它TYPE B的卡的操作)
{
	unsigned char status;

	 
	 uchar t;


//	do{
//			TR0 = 0;
//			status = M531PiccRequestB(0, 0, 0, &g_cReceBuf[0]);//寻卡 							 
//	   		TR0 = 1;
//	}
//	while(status);

//delete by cong

//t = 10;
t = 1;
while(t!=0){
			TR0 = 0;
			status = M531PiccRequestB(0, 0, 0, &g_cReceBuf[0]);//寻卡 
			TR0 = 1;							 
	   	t--;
	}
	

//     g_cFWI    = 0xFF;
  //   g_cCidNad = 8;
  if(status == 0){ 	
  		TR0 = 0;
     	status = M531PiccAttrib(&g_cReceBuf[1], g_cReceBuf[10]&0x0F, &g_cReceBuf[12]);
	 	TR0 = 1;
	if (status == MI_OK)
		{ 	
			TR0 = 0;
			status = Get_UID_TypeB(&g_cReceBuf[0]);
			TR0 = 1;
			if ( (status == MI_OK)&&(g_cReceBuf[8]==0x90)&&(g_cReceBuf[9]==0x00))  //返回卡号
			{	  
				
				BEEP(50);
			
	
			 ri=DS1302Read(0x87);
			 yue=DS1302Read(0x89);
			 nian=DS1302Read(0x8d);
			 ri=ri/16*10+ri%16;
			 yue=yue/16*10+yue%16;
			 nian=nian/16*10+nian%16;
			 
//			 
			  if(panduan(nian,yue,ri)== 0x01){   //两种情况可以取货：未曾拿过、过了限期

			 
			 Draw_LOGO(Cl,Cl,Cl);
			LCD_PutString(0,1,"                ");
			LCD_PutString(0,2,"                ");
			LCD_PutString(0,3,"                ");
			 DisplayLcd(SEL_CHAN);
				 sc_speech(4);
			 set_num = USER_STATE;
			 user_channel = 0;
			  
			 
		 	 	 tmp_show = 0;
			 }
			 else
			 {	
			 Draw_LOGO(Cl,Cl,Cl);
			 LCD_PutString(0,1,"                ");
			 LCD_PutString(0,2,"                ");
			 LCD_PutString(0,3,"                ");
				DisplayLcd(ERR_MES);
				set_num = USER_STATE_ERR;tmp_show = 0;
				 sc_speech(3);
				
			 }
			 
			
			}
			//flag1 = 0;
		}
		
	}

	


}

uchar panduan(uchar y,uchar m, uchar d)
{
	

	unsigned int i,j;
	unsigned int dis;
	unsigned int num = 912;
	unsigned int num_tmp;
	unsigned char j_tmp;
	unsigned char oldy,oldd,oldm;
	
	i = ee_indx;
	j = ee_id;
	
	
	
	for(num_tmp=0;num_tmp<912;num_tmp++)
	{
		
		
		
		for(j_tmp=0;j_tmp<8;)
		{
			if(g_cReceBuf[j_tmp]==R_EROM(i,j*32+j_tmp+3))
				j_tmp++;
			else
				break;			
		}
		
		if(j_tmp==8)
		{
			oldy = R_EROM(i,j*32);
			oldm = R_EROM(i,j*32+1);
			oldd = R_EROM(i,j*32+2);
		//如果UID相同，则看年月是否满足要求
			if(y>oldy)
			{
				
				dis = 365-oldm*30-oldd+m*30+d;
				
			}
			else
				dis = m*30+d-oldm*30-oldd;
			if(dis>=Time_Range)
				return 0x01;
			else
				return 0x00;
		}
		else
		{
			if(j == 0)
			{
				j = 15;
				if(i == 0)
					i = 56;
				else
					i = i-1;
			}
			else
				j = j-1;
		}
				
	}
	
	
	
	

	return 0x01;
}



/////////////////////////////////////////////////////////////////////
//延时子程序
/////////////////////////////////////////////////////////////////////
void DelayMs(unsigned int _MS)
{

while(_MS--)
 {
     //大致延时1mS
     Delay_50us(245);
	 Delay_50us(245);
 }
}
void Delay_50us(unsigned char _50us)
{
 while(--_50us);
}
void flesh_set()
{ 
 	 if(set_num == 1)  {
     switch(tab_num)
		{
		   case 0:  WriteCommand(0x91);
					WriteData('0'+t_tmp[0]/16);
					WriteData('0'+t_tmp[0]%16);
					break;
		   case 1:  WriteCommand(0x93);
					WriteData('0'+t_tmp[1]/16);
					WriteData('0'+t_tmp[1]%16);
					break;
		   case 2:  WriteCommand(0x95);
					WriteData('0'+t_tmp[2]/16);
					WriteData('0'+t_tmp[2]%16);
					break;
		   case 3:  WriteCommand(0x88);
					WriteData('0'+t_tmp[3]/16);
					WriteData('0'+t_tmp[3]%16);
					break;
		   case 4:  WriteCommand(0x8a);
		   
					WriteData('0'+t_tmp[4]/16);
					WriteData('0'+t_tmp[4]%16);
					break;
//		   case 5:  WriteCommand(0x91);
//					WriteData('0'+year/16);
//					WriteData('0'+year%16);
//					tab_num = 0;
					//break;
		   default: break;
		}
		}

		 if(set_num == 3)  {
     switch(tab_num)
		{
		   case 0:  WriteCommand(0x93);
					WriteData('0'+set_led_time[0]/10);
					WriteData('0'+set_led_time[0]%10);
					break;
		   case 1:  WriteCommand(0x95);
					WriteData('0'+set_led_time[1]/10);
					WriteData('0'+set_led_time[1]%10);
					break;
		   case 2:  WriteCommand(0x8b);
					WriteData('0'+set_led_time[2]/10);
					WriteData('0'+set_led_time[2]%10);
					break;
		   case 3:  WriteCommand(0x8d);
					WriteData('0'+set_led_time[3]/10);
					WriteData('0'+set_led_time[3]%10);
					break;

		   default: break;
		}
		}
		b_flesh = 0;
}



void flesh_clr()
{ 


 	    if(set_num == 1)  {
     switch(tab_num)
		{
		   case 0:  LCD_PutString(1,2,"  ");
		           
				
					break;
		   case 1:  LCD_PutString(3,2,"  ");
		           
					
					break;
		   case 2:  LCD_PutString(5,2,"  ");
		           
				
					break;
		   case 3:  LCD_PutString(0,3,"  ");
		            
				
					break;
		   case 4:  LCD_PutString(2,3,"  ");
		            
					break;

		   default: break;
		}
		}



		 if(set_num == 3)  {
     switch(tab_num)
		{
		   case 0:  LCD_PutString(3,2,"  ");		           				
					break;
		   case 1:  LCD_PutString(5,2,"  ");					
					break;
		   case 2:  LCD_PutString(3,3,"  ");				
					break;
		   case 3:  LCD_PutString(5,3,"  ");				
					break;
		   default: break;
		}
		}
		b_flesh = 0;
}

void user_ch()
{
	if(SCH1 == 0)
	{
		DelayMs(5);
		if(SCH1 == 0){
				if(out1 == 0)
					select_ch(CH1);
				else
					set_num = NO_INV_STATE;
				
			
			}
	}
	if(TAB == 0)
	{
		DelayMs(5);
	if(TAB == 0){
				
				if(out2 == 0)
					select_ch(CH2);
				else
					set_num = NO_INV_STATE;
			
			}
	}
	if(INC == 0)
	{
		DelayMs(5);
		if(INC == 0){
				
				if(out3 == 0)
					select_ch(CH3);
				else
					set_num = NO_INV_STATE;
			
			}
	}
	if(SUB == 0)
	{
		DelayMs(5);
		if(SUB == 0){
			
				if(out4 == 0)
					select_ch(CH4);
				else
					set_num = NO_INV_STATE;
			
				
			}
	}
	if(set_num == NO_INV_STATE){
		DisplayLcd(NO_INV);
		BEEP(30);
		DelayMs(200);
		BEEP(30);
		DelayMs(200);
		BEEP(30);				
		set_num = USER_STATE;
		tmp_show = 3;//显示缺货后再次等待选货，就少等待一会。最终到8时回到主屏幕
		sc_speech(6);
		 }
}

void select_ch(unsigned channel)
{
	uchar ri,yue,nian;
	//Write_E(ee_indx,ee_id*2,(nian-10)*16+yue);
	//Write_E(ee_indx,ee_id*2+1,ri);
	ri=DS1302Read(0x87);
	yue=DS1302Read(0x89);
	nian=DS1302Read(0x8d);
	ri=ri/16*10+ri%16;
	yue=yue/16*10+yue%16;
	nian=nian/16*10+nian%16;
	Write_EE_rec(nian,yue,ri);
	DelayMs(50);
	num_times++;
	
	Write_E(57,5,num_times%10);
	Write_E(57,6,num_times/10%10);
	Write_E(57,7,num_times/100%10);
	Write_E(57,8,num_times/1000%10);
	Write_E(57,9,num_times/10000);
	//aa=0;
	if(channel == CH1){
		MENTOR(1,ZHEN);
		DelayMs(10);
		user_channel = 1;
		}
	if(channel == CH2){
		MENTOR(2,ZHEN);
		DelayMs(10);
		user_channel = 2;
		}
	if(channel == CH3){
		MENTOR(3,ZHEN);
		DelayMs(10);
		user_channel = 3;
		}
	if(channel == CH4){ 
		MENTOR(4,ZHEN);	
		DelayMs(10);
		user_channel = 4;
		}

	
	
	set_num=GET_INV_STATE;
	
	TR0 = 0;
	tmp_show = 0;
	a=0;
	
	TH0 = 0Xc8;
	TL0 = 0Xc0;
	TR0 = 1;

	
		
}

void T0_time() interrupt 1
{
	TH0 = 0Xc8;
	TL0 = 0Xc0;

	a++;
	aa++;

	if(start_long_set==1){
		if(a%20==0){
			long_set+=1;}
			}
	

if(aa == 250){
	aa = 0;
//	update_logo = 0;
	}	

	if(a == 40)
	{	
		a = 0;
		tmp_show+=1;
	b=~b;	
	b_flesh = 1;	
		
	
		
	}
	
	
	
}	
void T1_time() interrupt 3
{
	TH1 = 0X3C;
	TL1 = 0Xb0;
	ask_a+=1;
	if(ask_a==9){
		ask_it = 1;
		ask_a  = 0;
		}
	
}	




